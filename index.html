<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PiSlider ‚Äî Web Command Center</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body class="idle">

    <header id="header">
        <div class="title-block">
            <h1>PiSlider Controller</h1>
            <span class="version-tag">Unified Engine v2.4 ‚Äî Holy Grail / Cinematic / Macro</span>
        </div>
        <div class="header-buttons">
            <button id="modeTimelapse"  class="mode-btn active"  onclick="setMode('timelapse')">Timelapse</button>
            <button id="modeCinematic"  class="mode-btn"         onclick="setMode('cinematic')">Cinematic</button>
            <button id="modeMacro"      class="mode-btn"         onclick="setMode('macro')">Macro Focus</button>
            <button id="startBtn"       class="mode-btn active"  onclick="startRun()">Start Sequence</button>
            <button id="stopBtn"        class="mode-btn stop-style" onclick="handleStopReset()">E-Stop</button>
        </div>
    </header>

    <main id="mainLayout">
        <aside id="sidebar">

            <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
            <!-- HARDWARE CONFIG                                     -->
            <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
            <section class="group-box">
                <h3 class="group-title">Hardware Config</h3>

                <div class="control-item">
                    <label>Active Camera Source</label>
                    <select id="camera_select" onchange="onCameraChange(this.value)">
                        <option value="picam">Pi Camera (IMX477)</option>
                        <option value="sony">Sony WiFi (PTP/IP)</option>
                        <option value="s2">S2 Trigger (GPIO)</option>
                    </select>
                </div>

                <!-- Sony WiFi Connection Panel -->
                <div id="sony_guide" class="guide-box" style="display:none">
                    <h4 class="guide-title">Sony WiFi Camera</h4>
                    <div class="row" style="gap:6px; margin-bottom:6px;">
                        <div class="control-item half">
                            <label>Network SSID</label>
                            <input type="text" id="sony_ssid" value="DIRECT-xxxx:ILCE-7M3"
                                   placeholder="Sony camera SSID">
                        </div>
                        <div class="control-item half">
                            <label>Password</label>
                            <input type="password" id="sony_password" value=""
                                   placeholder="Camera WiFi password" autocomplete="off">
                        </div>
                    </div>
                    <!-- sony_ip hidden ‚Äî Sony hotspot always assigns 192.168.122.1 -->
                    <input type="hidden" id="sony_ip" value="192.168.122.1">
                    <div class="row" style="gap:6px; margin-bottom:6px;">
                        <button class="mode-btn" style="flex:1;" onclick="connectSony()">Connect</button>
                        <button class="mode-btn stop-style" style="flex:0.5;" onclick="disconnectSony()">Drop</button>
                    </div>
                    <div id="sony_status" class="readout-card" style="font-size:0.72rem; text-align:left; color:var(--text-dim);">
                        DISCONNECTED ‚Äî Set SSID + password then Connect
                    </div>
                    <ul class="guide-text" style="margin-top:6px;">
                        <li>Camera: <b>Network ‚Üí Remote Ctrl ‚Üí ON</b></li>
                        <li>Camera: <b>Still Img Save ‚Üí Host Device</b></li>
                        <li>Pi connects via wlan1 ¬∑ hotspot IP auto-assigned</li>
                    </ul>
                </div>

                <div class="control-item">
                    <label>Storage Destination</label>
                    <div class="row" style="gap:6px;">
                        <input type="text" id="save_path" value="/home/tim/Pictures/PiSlider"
                               style="flex:1;" onchange="sendCmd('set_save_path', {value:this.value})">
                        <button onclick="openFolderBrowser()" style="white-space:nowrap; flex-shrink:0; padding:6px 10px;">
                            Browse‚Ä¶
                        </button>
                    </div>
                </div>

                <!-- Relay / Lighting Controls -->
                <div class="row" style="margin-top:10px; gap:8px;">
                    <button class="relay-btn" id="relay1_btn" onclick="toggleRelay(1)">
                        Ring Light <span id="relay1_state">OFF</span>
                    </button>
                    <button class="relay-btn" id="relay2_btn" onclick="toggleRelay(2)">
                        Laser Grid <span id="relay2_state">OFF</span>
                    </button>
                </div>

                <!-- High Power Mode -->
                <div class="row" style="margin-top:8px; gap:8px; align-items:center;">
                    <label class="toggle-label" style="flex:1;">
                        <input type="checkbox" id="high_power_mode"
                               onchange="sendCmd('cinematic_set_high_power',
                                        {enabled: this.checked})">
                        High Power Mode
                    </label>
                    <span style="font-size:0.65rem; color:var(--text-muted); flex:2;">
                        ~1.2A run current ‚Äî for steep rail angles / heavy loads
                    </span>
                </div>
            </section>

            <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
            <!-- EXPOSURE ENGINE                                     -->
            <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
            <section id="exposure_panel" class="group-box">
                <h3 class="group-title">Exposure Engine</h3>

                <!-- HG override notice ‚Äî shown when HG is enabled -->
                <div id="hg_override_notice" class="readout-card" style="
                    display:none; background:#1a1200; border-color:var(--accent-gold);
                    color:var(--accent-gold); font-size:0.75rem; margin-bottom:10px; text-align:center;">
                    ‚ö† Holy Grail mode is active ‚Äî exposure is controlled automatically
                </div>

                <div id="remote_controls">
                    <!-- AE / AWB toggles -->
                    <div class="row" style="margin-bottom:10px; gap:16px;">
                        <label class="toggle-label">
                            <input type="checkbox" id="ae_toggle" checked onchange="sendPicamSettings()">
                            Auto Exposure
                        </label>
                        <label class="toggle-label">
                            <input type="checkbox" id="awb_toggle" checked onchange="sendPicamSettings()">
                            Auto WB
                        </label>
                    </div>

                    <!-- Shutter ‚Äî quarter-stop slider -->
                    <div class="control-item">
                        <label>Shutter: <span id="shutter_label">1/125</span></label>
                        <input type="range" id="shutter_slider" min="0" max="100" value="50"
                               oninput="onShutterSlider(this.value)">
                    </div>

                    <!-- ISO ‚Äî quarter-stop slider -->
                    <div class="control-item">
                        <label>ISO: <span id="iso_label">400</span></label>
                        <input type="range" id="iso_slider" min="0" max="100" value="30"
                               oninput="onISOSlider(this.value)">
                    </div>

                    <!-- Kelvin / WB slider -->
                    <div class="control-item">
                        <label>White Balance: <span id="wb_label">5500K</span></label>
                        <input type="range" id="wb_slider" min="2500" max="10000" step="50" value="5500"
                               oninput="onWBSlider(this.value)">
                    </div>
                </div>

                <div class="control-item" style="margin-top:8px;">
                    <label>Trigger Pulse Status</label>
                    <div id="shutter_indicator" class="readout-card" style="color:var(--text-dim)">READY</div>
                </div>

                <button onclick="sendCmd('take_preview')" class="mode-btn" style="width:100%; margin-top:8px;">
                    Take Preview Shot
                </button>
            </section>

            <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
            <!-- SEQUENCE SETTINGS                                   -->
            <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
            <section class="group-box">
                <h3 class="group-title">Sequence Settings</h3>

                <!-- Frame Count vs Start/End toggle -->
                <div class="row" style="margin-bottom:8px; gap:12px;">
                    <label class="toggle-label">
                        <input type="radio" name="seq_mode" value="frames" checked
                               onchange="onSeqModeChange('frames')"> Frame Count
                    </label>
                    <label class="toggle-label">
                        <input type="radio" name="seq_mode" value="duration"
                               onchange="onSeqModeChange('duration')"> Start / End Time
                    </label>
                </div>

                <!-- Frame count row -->
                <div id="seq_frames_row">
                    <div class="control-item">
                        <label>Frame Count</label>
                        <input type="number" id="total_frames" value="300" step="10" min="1"
                               onchange="sendCmd('set_total_frames', {value:parseInt(this.value)})">
                    </div>
                    <!-- Interval ‚Äî only shown when HG is disabled -->
                    <div class="control-item" id="manual_interval_row" style="margin-top:6px;">
                        <label>Interval (s) <span style="color:var(--text-dim); font-weight:normal;">‚Äî per-phase intervals set in HG when enabled</span></label>
                        <input type="number" id="manual_interval" value="5.0" step="0.5" min="0.5">
                    </div>
                </div>

                <!-- Duration row (hidden by default) -->
                <div id="seq_duration_row" style="display:none;">
                    <div class="control-item">
                        <label>Start Time</label>
                        <input type="datetime-local" id="seq_start_time"
                               style="width:100%;box-sizing:border-box;">
                    </div>
                    <div class="control-item">
                        <label>End Time</label>
                        <input type="datetime-local" id="seq_end_time"
                               style="width:100%;box-sizing:border-box;">
                    </div>
                    <div class="control-item">
                        <label>Interval (s)</label>
                        <input type="number" id="hg_int_dur" value="5.0" step="0.5" min="1">
                    </div>
                    <div class="readout-card" id="seq_duration_calc" style="font-size:0.75rem; margin-top:4px;">
                        ‚Äî frames estimated
                    </div>
                </div>

                <div class="row" style="margin-top:6px;">
                    <div class="control-item half">
                        <label>Vibe Delay (s)</label>
                        <input type="number" id="vibe_delay" value="1.0" step="0.1" min="0">
                    </div>
                    <div class="control-item half">
                        <label>Exp Margin (s)</label>
                        <input type="number" id="exp_margin" value="0.2" step="0.1" min="0">
                    </div>
                </div>

                <!-- Trigger Mode -->
                <div id="trigger_section">
                <div class="sub-group-title" style="margin-top:10px;">Shutter Trigger Mode</div>
                <div class="radio-group">
                    <label>
                        <input type="radio" name="trigger_mode" value="normal" checked
                               onchange="onTriggerModeChange('normal')">
                        Normal (interval timer)
                    </label>
                    <label>
                        <input type="radio" name="trigger_mode" value="aux_only"
                               onchange="onTriggerModeChange('aux_only')">
                        AUX Only ‚Äî wait for external trigger each shot
                    </label>
                    <label>
                        <input type="radio" name="trigger_mode" value="aux_hybrid"
                               onchange="onTriggerModeChange('aux_hybrid')">
                        AUX Hybrid ‚Äî trigger OR interval, whichever first
                    </label>
                    <label>
                        <input type="radio" name="trigger_mode" value="picam_motion_only"
                               onchange="onTriggerModeChange('picam_motion_only')">
                        Camera Motion Only ‚Äî fire on motion detection (PiCam)
                    </label>
                    <label>
                        <input type="radio" name="trigger_mode" value="picam_motion_hybrid"
                               onchange="onTriggerModeChange('picam_motion_hybrid')">
                        Camera Motion Hybrid ‚Äî motion OR interval, whichever first
                    </label>
                </div>

                <!-- AUX manual fire -->
                <button id="auxFireBtn" style="width:100%; margin-top:8px; border-color:var(--accent-gold); color:var(--accent-gold);"
                        onclick="sendCmd('aux_trigger')">
                    ‚ö° Fire AUX Trigger (Manual)
                </button>

                <!-- Motion detection settings ‚Äî shown for picam_motion modes -->
                <div id="motion_settings" style="display:none; margin-top:10px;">
                    <div class="sub-group-title">Motion Detection Zone</div>
                    <!-- Note shown when non-picam camera selected -->
                    <div id="motion_camera_note" class="readout-card" style="
                        display:none; background:#1a1200; border-color:var(--accent-gold);
                        color:var(--accent-gold); font-size:0.72rem; margin-bottom:6px;">
                        ‚Ñπ Using PiCam preview for detection even though capture is via Sony/S2
                    </div>
                    <div class="readout-card" style="font-size:0.75rem; margin-bottom:8px; text-align:left;">
                        <b>Drag the box corners</b> on the live feed to define the watch zone.
                        Drag inside the box to move it. Double-click feed to re-center loupe.
                    </div>
                    <div class="row">
                        <div class="control-item half">
                            <label>Sensitivity
                                <span style="color:var(--text-dim); font-size:0.7em; font-weight:normal;
                                             display:block; margin-top:2px;">
                                    ‚Üì lower = more sensitive (px¬≤)<br>
                                    500 = high, 2000 = normal, 8000 = large objects only
                                </span>
                            </label>
                            <input type="number" id="motion_threshold" value="2000" step="500" min="200"
                                   onchange="sendMotionSettings()">
                        </div>
                        <div class="control-item half">
                            <label>Warmup Frames
                                <span style="color:var(--text-dim); font-size:0.7em; font-weight:normal;
                                             display:block; margin-top:2px;">
                                    frames before triggers fire
                                </span>
                            </label>
                            <input type="number" id="motion_warmup" value="10" step="1" min="1"
                                   onchange="sendMotionSettings()">
                        </div>
                    </div>
                    <div class="readout-card" id="motion_roi_readout"
                         style="font-size:0.72rem; margin-top:4px; color:var(--accent-teal);">
                        Zone: full frame
                    </div>
                </div>
                </div><!-- end trigger_section -->

            </section><!-- end Sequence Settings -->

            <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
            <!-- HOLY GRAIL ADAPTIVE                                 -->
            <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
            <section class="group-box" id="hg_section">
                <h3 class="group-title">Holy Grail Adaptive</h3>

                <label class="toggle-label" style="margin-bottom:10px; display:flex; gap:8px; align-items:center;">
                    <input type="checkbox" id="hg_enabled" checked
                           onchange="sendHGSettings(); updateHGExposureLock();">
                    Enable Holy Grail Mode
                </label>

                <!-- ‚îÄ‚îÄ COMPASS CALIBRATION ‚îÄ‚îÄ -->
                <div class="sub-group-title">Rig Calibration</div>
                <div class="guide-box" style="margin-bottom:10px;">
                    <h4 class="guide-title">Bearing Reference Calibration</h4>
                    <p class="guide-text" style="margin-bottom:6px; display:block;">
                        Point the camera level at a known compass bearing, then click <b>Set Ref + Calibrate</b>.
                        The system will zero the motor odometer to that angle so all subsequent
                        positions, keyframes and sky-map sweeps use real-world bearings.
                    </p>
                    <div class="row" style="gap:6px; margin-bottom:6px; align-items:flex-end;">
                        <div class="control-item" style="flex:1; margin-bottom:0;">
                            <label>Reference Bearing</label>
                            <select id="calib_bearing">
                                <option value="0">N ‚Äî 0¬∞</option>
                                <option value="45">NE ‚Äî 45¬∞</option>
                                <option value="90" selected>E ‚Äî 90¬∞</option>
                                <option value="135">SE ‚Äî 135¬∞</option>
                                <option value="180">S ‚Äî 180¬∞</option>
                                <option value="225">SW ‚Äî 225¬∞</option>
                                <option value="270">W ‚Äî 270¬∞</option>
                                <option value="315">NW ‚Äî 315¬∞</option>
                                <option value="custom">Custom ¬∞</option>
                            </select>
                        </div>
                        <div class="control-item" style="flex:0.6; margin-bottom:0;" id="calib_custom_wrap" style="display:none;">
                            <label>Custom (¬∞)</label>
                            <input type="number" id="calib_custom_deg" value="90" step="1" min="0" max="359">
                        </div>
                    </div>

                    <!-- Nudge controls for fine aim -->
                    <div class="sub-group-title" style="margin-top:4px;">Fine Aim (Nudge)</div>
                    <div style="display:flex; gap:6px; flex-wrap:wrap; margin-bottom:8px;">
                        <button class="nudge-btn" onclick="nudgeAxis('pan', -10)">‚óÄ‚óÄ 10¬∞</button>
                        <button class="nudge-btn" onclick="nudgeAxis('pan', -1)">‚óÄ 1¬∞</button>
                        <button class="nudge-btn" onclick="nudgeAxis('pan', -0.1)">‚óÄ 0.1¬∞</button>
                        <button class="nudge-btn" onclick="nudgeAxis('pan', 0.1)">0.1¬∞ ‚ñ∂</button>
                        <button class="nudge-btn" onclick="nudgeAxis('pan', 1)">1¬∞ ‚ñ∂</button>
                        <button class="nudge-btn" onclick="nudgeAxis('pan', 10)">10¬∞ ‚ñ∂‚ñ∂</button>
                    </div>
                    <div style="display:flex; gap:6px; flex-wrap:wrap; margin-bottom:8px;">
                        <button class="nudge-btn" onclick="nudgeAxis('tilt', -5)">‚ñº‚ñº 5¬∞</button>
                        <button class="nudge-btn" onclick="nudgeAxis('tilt', -0.5)">‚ñº 0.5¬∞</button>
                        <button class="nudge-btn" onclick="nudgeAxis('tilt', 0.5)">‚ñ≤ 0.5¬∞</button>
                        <button class="nudge-btn" onclick="nudgeAxis('tilt', 5)">‚ñ≤‚ñ≤ 5¬∞</button>
                    </div>

                    <div id="calib_readout" class="readout-card" style="font-size:0.75rem; text-align:left; margin-bottom:8px; color:var(--text-dim);">
                        NOT CALIBRATED ‚Äî Pan: ‚Äî¬∞  Tilt: ‚Äî¬∞
                    </div>
                    <button class="mode-btn" style="width:100%;" onclick="calibrateOrigin()">
                        ‚ú¶ Set Reference &amp; Calibrate Origin
                    </button>
                </div>

                <!-- ‚îÄ‚îÄ PAN / TILT SOFT LIMITS ‚îÄ‚îÄ -->
                <div class="sub-group-title" style="margin-top:10px;">Pan / Tilt Soft Limits</div>
                <div class="guide-box" style="margin-bottom:8px;">
                    <p class="guide-text" style="display:block;">
                        Move the camera to the <b>furthest safe position</b> in each
                        direction, then click the capture button to record that limit.
                        The system will never drive past these limits during joystick
                        or cinematic playback.
                    </p>
                </div>
                <div class="sub-group-title">Pan Limits</div>
                <div class="row" style="gap:6px; margin-bottom:6px; align-items:flex-end;">
                    <div class="control-item quarter" style="margin-bottom:0;">
                        <label>Min ¬∞</label>
                        <input type="number" id="pan_min_val" value="-90" step="1">
                    </div>
                    <div class="control-item quarter" style="margin-bottom:0;">
                        <label>Max ¬∞</label>
                        <input type="number" id="pan_max_val" value="90" step="1">
                    </div>
                    <button class="nudge-btn" onclick="setLimitFromField('pan','min')" title="Set pan min from field">Set Min</button>
                    <button class="nudge-btn" onclick="captureLimitNow('pan','min')" title="Capture current pan as min">‚ä≤ Pos</button>
                    <button class="nudge-btn" onclick="captureLimitNow('pan','max')" title="Capture current pan as max">Pos ‚ä≥</button>
                    <button class="nudge-btn" onclick="setLimitFromField('pan','max')" title="Set pan max from field">Set Max</button>
                </div>
                <div class="sub-group-title">Tilt Limits</div>
                <div class="row" style="gap:6px; margin-bottom:8px; align-items:flex-end;">
                    <div class="control-item quarter" style="margin-bottom:0;">
                        <label>Min ¬∞</label>
                        <input type="number" id="tilt_min_val" value="-30" step="1">
                    </div>
                    <div class="control-item quarter" style="margin-bottom:0;">
                        <label>Max ¬∞</label>
                        <input type="number" id="tilt_max_val" value="30" step="1">
                    </div>
                    <button class="nudge-btn" onclick="setLimitFromField('tilt','min')">Set Min</button>
                    <button class="nudge-btn" onclick="captureLimitNow('tilt','min')">‚ä≤ Pos</button>
                    <button class="nudge-btn" onclick="captureLimitNow('tilt','max')">Pos ‚ä≥</button>
                    <button class="nudge-btn" onclick="setLimitFromField('tilt','max')">Set Max</button>
                </div>
                <div class="readout-card" id="limits_readout" style="font-size:0.72rem; text-align:left;">
                    Pan: ‚Äî¬∞ ‚Üí ‚Äî¬∞ &nbsp;|&nbsp; Tilt: ‚Äî¬∞ ‚Üí ‚Äî¬∞
                </div>

                <!-- Location -->
                <div class="sub-group-title">Location</div>
                <div class="row" style="align-items:flex-end; gap:6px;">
                    <div class="control-item half">
                        <label>Latitude</label>
                        <input type="number" id="hg_lat" value="49.8951" step="0.0001"
                               onchange="sendHGSettings()">
                    </div>
                    <div class="control-item half">
                        <label>Longitude</label>
                        <input type="number" id="hg_lon" value="-97.1384" step="0.0001"
                               onchange="sendHGSettings()">
                    </div>
                    <button id="gpsBtn" onclick="grabGPS()"
                            title="Auto-fill from browser GPS"
                            style="flex-shrink:0; padding:6px 10px; margin-bottom:2px;
                                   background:none; border:1px solid #444; color:#888;
                                   border-radius:6px; cursor:pointer; font-size:0.85rem;
                                   white-space:nowrap;">
                        üìç
                    </button>
                </div>
                <div class="control-item">
                    <label>Timezone</label>
                    <input type="text" id="hg_tz" value="America/Winnipeg">
                </div>

                <!-- Camera Orientation -->
                <div class="sub-group-title" style="margin-top:10px;">Camera Orientation</div>
                <div class="row">
                    <div class="control-item half">
                        <label>Camera Az (¬∞)</label>
                        <input type="number" id="hg_cam_az" value="180" step="1">
                    </div>
                    <div class="control-item half">
                        <label>Camera Alt (¬∞)</label>
                        <input type="number" id="hg_cam_alt" value="0" step="1">
                    </div>
                </div>
                <div class="row">
                    <div class="control-item half">
                        <label>HFOV (¬∞)</label>
                        <input type="number" id="hg_hfov" value="60" step="1">
                    </div>
                    <div class="control-item half">
                        <label>VFOV (¬∞)</label>
                        <input type="number" id="hg_vfov" value="40" step="1">
                    </div>
                </div>

                <!-- HG Advanced ‚Äî collapsible -->
                <button class="collapsible-btn" onclick="toggleAdvanced('hg_advanced')" style="margin-top:12px;">
                    Advanced Settings ‚ñº
                </button>
                <div id="hg_advanced" class="collapsible-content">

                    <div class="sub-group-title">EV Targets (Stops)</div>
                    <div class="row">
                        <div class="control-item quarter"><label>Day</label>
                            <input type="number" id="hg_ev_day" value="13.0" step="0.5"></div>
                        <div class="control-item quarter"><label>Golden</label>
                            <input type="number" id="hg_ev_golden" value="10.0" step="0.5"></div>
                        <div class="control-item quarter"><label>Twilight</label>
                            <input type="number" id="hg_ev_twilight" value="6.0" step="0.5"></div>
                        <div class="control-item quarter"><label>Night</label>
                            <input type="number" id="hg_ev_night" value="3.0" step="0.5"></div>
                    </div>

                    <div class="sub-group-title">Kelvin Targets</div>
                    <div class="row">
                        <div class="control-item quarter"><label>Day</label>
                            <input type="number" id="hg_k_day" value="5500" step="50"></div>
                        <div class="control-item quarter"><label>Golden</label>
                            <input type="number" id="hg_k_golden" value="4800" step="50"></div>
                        <div class="control-item quarter"><label>Twilight</label>
                            <input type="number" id="hg_k_twilight" value="4200" step="50"></div>
                        <div class="control-item quarter"><label>Night</label>
                            <input type="number" id="hg_k_night" value="3500" step="50"></div>
                    </div>

                    <div class="sub-group-title">Interval Targets (s)</div>
                    <div class="row">
                        <div class="control-item quarter"><label>Day</label>
                            <input type="number" id="hg_int_day" value="5.0" step="0.5"></div>
                        <div class="control-item quarter"><label>Golden</label>
                            <input type="number" id="hg_int_golden" value="7.0" step="0.5"></div>
                        <div class="control-item quarter"><label>Twilight</label>
                            <input type="number" id="hg_int_twilight" value="10.0" step="0.5"></div>
                        <div class="control-item quarter"><label>Night</label>
                            <input type="number" id="hg_int_night" value="20.0" step="0.5"></div>
                    </div>

                    <!-- ISO / Aperture limits -->
                    <div class="sub-group-title">Camera Limits</div>
                    <div class="row">
                        <div class="control-item half"><label>ISO Min</label>
                            <input type="number" id="hg_iso_min" value="100" step="100"></div>
                        <div class="control-item half"><label>ISO Max</label>
                            <input type="number" id="hg_iso_max" value="3200" step="100"></div>
                    </div>
                    <div class="row">
                        <div class="control-item half"><label>Aperture Day</label>
                            <input type="number" id="hg_ap_day" value="5.6" step="0.1"></div>
                        <div class="control-item half"><label>Aperture Night</label>
                            <input type="number" id="hg_ap_night" value="2.8" step="0.1"></div>
                    </div>
                </div>
            </section>

            <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
            <!-- MOTION CONTROL                                      -->
            <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
            <section class="group-box">
                <h3 class="group-title">Motion Control</h3>

                <!-- Axis selector -->
                <div class="control-item">
                    <label>Axis</label>
                    <div class="radio-group">
                        <label><input type="radio" name="motion_axis" value="slider" checked> Slider (mm)</label>
                        <label><input type="radio" name="motion_axis" value="pan"> Pan (¬∞)</label>
                        <label><input type="radio" name="motion_axis" value="tilt"> Tilt (¬∞)</label>
                    </div>
                </div>

                <!-- Distribution curve -->
                <div class="control-item">
                    <label>Easing Curve</label>
                    <select id="motion_curve">
                        <option value="linear">Linear</option>
                        <option value="inverted_linear">Inverted Linear</option>
                        <option value="even">Even (Constant Speed)</option>
                        <option value="parabolic" selected>Parabolic</option>
                        <option value="inverted_parabolic">Inverted Parabolic</option>
                        <option value="gaussian">Gaussian</option>
                        <option value="inverted_gaussian">Inverted Gaussian</option>
                        <option value="catenary">Catenary</option>
                        <option value="inverted_catenary">Inverted Catenary</option>
                        <option value="ellipsoidal">Ellipsoidal</option>
                        <option value="inverted_ellipsoidal">Inverted Ellipsoidal</option>
                        <option value="cycloid">Cycloid</option>
                        <option value="inverted_cycloid">Inverted Cycloid</option>
                        <option value="lame">Lam√© Curve</option>
                        <option value="inverted_lame">Inverted Lam√©</option>
                    </select>
                </div>

                <!-- Travel + Intervals -->
                <div class="row">
                    <div class="control-item half">
                        <label>Total Travel <span id="travel_units">mm</span></label>
                        <input type="number" id="motion_total" value="300" step="10">
                    </div>
                    <div class="control-item half">
                        <label>Intervals</label>
                        <input type="number" id="motion_intervals" value="100" step="10">
                    </div>
                </div>

                <div class="button-grid" style="margin-top:8px;">
                    <button onclick="runMotionTest()" class="mode-btn">Run Test Motion</button>
                    <button onclick="homeAxis()" class="mode-btn">Home Axis</button>
                </div>
            </section>

            <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
            <!-- CINEMATIC MODE                                      -->
            <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
            <section class="group-box" id="cinematic_panel" style="display:none;">
                <h3 class="group-title">Cinematic Motion Control</h3>

                <!-- Live / Programmed sub-mode toggle -->
                <div class="row" style="gap:6px; margin-bottom:10px;">
                    <button class="mode-btn active" id="cineModeLive"
                            onclick="setCineSubMode('live')" style="flex:1;">üéÆ Live</button>
                    <button class="mode-btn" id="cineModeProg"
                            onclick="setCineSubMode('programmed')" style="flex:1;">üé¨ Programmed</button>
                </div>

                <!-- ‚îÄ‚îÄ RECORD CONTROLS (always visible) ‚îÄ‚îÄ -->
                <div style="background:var(--panel-dark); border:1px solid #440000;
                            border-radius:8px; padding:10px; margin-bottom:10px;">
                    <!-- FPS selector -->
                    <div style="display:flex; gap:4px; margin-bottom:8px; align-items:center;">
                        <span style="font-size:0.65rem; color:var(--text-muted);
                                     white-space:nowrap; margin-right:4px;">REC FPS</span>
                        <button id="fps24" onclick="setCineFps(24)"
                                style="flex:1; padding:4px 0; font-size:0.72rem; font-weight:600;
                                       background:var(--accent-teal); color:#000;
                                       border:1px solid var(--accent-teal); border-radius:4px; cursor:pointer;">
                            24p</button>
                        <button id="fps25" onclick="setCineFps(25)"
                                style="flex:1; padding:4px 0; font-size:0.72rem; font-weight:600;
                                       background:none; color:#555;
                                       border:1px solid #333; border-radius:4px; cursor:pointer;">
                            25p</button>
                        <button id="fps30" onclick="setCineFps(30)"
                                style="flex:1; padding:4px 0; font-size:0.72rem; font-weight:600;
                                       background:none; color:#555;
                                       border:1px solid #333; border-radius:4px; cursor:pointer;">
                            30p</button>
                        <button id="fps60" onclick="setCineFps(60)"
                                style="flex:1; padding:4px 0; font-size:0.72rem; font-weight:600;
                                       background:none; color:#555;
                                       border:1px solid #333; border-radius:4px; cursor:pointer;">
                            60p</button>
                    </div>
                    <!-- Record / timecode row -->
                    <div class="row" style="gap:8px; align-items:center;">
                        <button id="recordBtn" onclick="toggleRecord()"
                                style="flex:2; padding:12px; font-size:0.9rem; font-weight:700;
                                       background:#1a0000; border:2px solid #cc2200; color:#ff4433;
                                       border-radius:6px; cursor:pointer; letter-spacing:0.05em;">
                            ‚óè REC
                        </button>
                        <div id="timecodeDisplay"
                             style="flex:3; font-family:monospace; font-size:1.1rem;
                                    color:#ff4433; text-align:center; letter-spacing:0.1em;
                                    background:#0a0000; border:1px solid #330000;
                                    border-radius:4px; padding:8px 4px;">
                            00:00:00:00
                        </div>
                        <div id="recIndicator"
                             style="width:14px; height:14px; border-radius:50%;
                                    background:#333; flex:0 0 14px;"></div>
                    </div>
                    <div style="font-size:0.65rem; color:var(--text-muted); margin-top:4px;
                                text-align:center;">
                        Controller A button also starts/stops recording
                    </div>
                </div>

                <!-- ‚îÄ‚îÄ SOFT LIMITS ‚îÄ‚îÄ -->
                <div class="sub-group-title">Soft Limits
                    <span id="cine_speed_badge"
                          style="float:right; font-size:0.6rem; font-weight:400;
                                 color:var(--accent-gold); padding:2px 6px;
                                 border:1px solid var(--accent-gold); border-radius:10px;">
                        CRAWL ONLY
                    </span>
                </div>
                <div style="margin-bottom:8px;">
                    <!-- Slider limits -->
                    <div style="font-size:0.7rem; color:var(--text-dim); margin-bottom:4px;">
                        SLIDER
                        <span id="cine_slider_cal" style="float:right; color:var(--text-muted);">uncalibrated</span>
                    </div>
                    <div class="row" style="gap:4px; margin-bottom:6px;">
                        <button class="mode-btn" onclick="calibrateLimit('slider','min')"
                                style="flex:1; font-size:0.65rem;">‚Üê Set Min</button>
                        <div id="cine_slider_bar" style="flex:3; height:20px; background:#1a1a1a;
                             border:1px solid #333; border-radius:4px; position:relative; overflow:hidden;">
                            <div id="cine_slider_pos" style="position:absolute; top:0; bottom:0;
                                 width:3px; background:var(--accent-teal); left:50%;"></div>
                        </div>
                        <button class="mode-btn" onclick="calibrateLimit('slider','max')"
                                style="flex:1; font-size:0.65rem;">Set Max ‚Üí</button>
                    </div>
                    <!-- Pan limits -->
                    <div style="font-size:0.7rem; color:var(--text-dim); margin-bottom:4px;">
                        PAN
                        <span id="cine_pan_cal" style="float:right; color:var(--text-muted);">uncalibrated</span>
                    </div>
                    <div class="row" style="gap:4px; margin-bottom:6px;">
                        <button class="mode-btn" onclick="calibrateLimit('pan','min')"
                                style="flex:1; font-size:0.65rem;">‚Üê Set Min</button>
                        <div id="cine_pan_bar" style="flex:3; height:20px; background:#1a1a1a;
                             border:1px solid #333; border-radius:4px; position:relative; overflow:hidden;">
                            <div id="cine_pan_pos" style="position:absolute; top:0; bottom:0;
                                 width:3px; background:var(--accent-teal); left:50%;"></div>
                        </div>
                        <button class="mode-btn" onclick="calibrateLimit('pan','max')"
                                style="flex:1; font-size:0.65rem;">Set Max ‚Üí</button>
                    </div>
                    <!-- Tilt limits -->
                    <div style="font-size:0.7rem; color:var(--text-dim); margin-bottom:4px;">
                        TILT
                        <span id="cine_tilt_cal" style="float:right; color:var(--text-muted);">uncalibrated</span>
                    </div>
                    <div class="row" style="gap:4px; margin-bottom:4px;">
                        <button class="mode-btn" onclick="calibrateLimit('tilt','min')"
                                style="flex:1; font-size:0.65rem;">‚Üê Set Min</button>
                        <div id="cine_tilt_bar" style="flex:3; height:20px; background:#1a1a1a;
                             border:1px solid #333; border-radius:4px; position:relative; overflow:hidden;">
                            <div id="cine_tilt_pos" style="position:absolute; top:0; bottom:0;
                                 width:3px; background:var(--accent-teal); left:50%;"></div>
                        </div>
                        <button class="mode-btn" onclick="calibrateLimit('tilt','max')"
                                style="flex:1; font-size:0.65rem;">Set Max ‚Üí</button>
                    </div>
                </div>

                <!-- ‚îÄ‚îÄ ARCTAN LOCK ‚îÄ‚îÄ -->
                <div class="sub-group-title">Arctan Subject Lock
                    <span id="arctan_lock_badge"
                          style="float:right; font-size:0.6rem; font-weight:400;
                                 color:var(--text-muted); padding:2px 6px;
                                 border:1px solid #333; border-radius:10px;">OFF</span>
                </div>
                <div style="font-size:0.72rem; color:var(--text-dim); margin-bottom:6px; line-height:1.5;">
                    Jog to subject from 3+ positions, mark each. System locks pan+tilt to subject.
                </div>
                <div class="row" style="gap:6px; margin-bottom:6px;">
                    <button class="mode-btn" onclick="arctanMarkPoint()"
                            style="flex:2;">üìç Mark Point
                        <span id="arctan_point_count" style="color:var(--accent-teal);">(0)</span>
                    </button>
                    <button class="mode-btn" onclick="arctanClear()"
                            style="flex:1; font-size:0.68rem;">Clear</button>
                </div>
                <div id="arctan_status_row" style="font-size:0.68rem; margin-bottom:6px; display:none;">
                    <div style="color:var(--accent-teal);">
                        ‚úì Solved ‚Äî RMS error: <span id="arctan_residual">‚Äî</span>¬∞
                    </div>
                    <div id="arctan_warning" style="color:var(--accent-gold); margin-top:2px;"></div>
                </div>
                <label class="toggle-label" style="margin-bottom:8px;">
                    <input type="checkbox" id="arctan_enable_cb"
                           onchange="arctanEnable(this.checked)" disabled>
                    Enable subject lock (pan+tilt follow subject)
                </label>

                <!-- ‚îÄ‚îÄ LIVE MODE ‚îÄ‚îÄ -->
                <div id="cine_live_panel">
                    <div class="sub-group-title">Inertia / Feel</div>
                    <div class="row" style="gap:4px; margin-bottom:8px;">
                        <button class="mode-btn" onclick="setRigPreset('light')"
                                style="flex:1; font-size:0.68rem;">Light</button>
                        <button class="mode-btn active" id="presetStandard"
                                onclick="setRigPreset('standard')"
                                style="flex:1; font-size:0.68rem;">Standard</button>
                        <button class="mode-btn" onclick="setRigPreset('heavy')"
                                style="flex:1; font-size:0.68rem;">Heavy</button>
                    </div>
                    <div class="control-item">
                        <label>Mass <span style="font-size:0.65rem; color:var(--text-muted);">
                            ‚Äî time to reach full speed</span></label>
                        <div class="row" style="gap:8px; align-items:center;">
                            <input type="range" id="cine_mass" min="0.05" max="2.0"
                                   step="0.05" value="0.40"
                                   oninput="updateInertiaLabel('mass'); sendInertia();"
                                   style="flex:3;">
                            <span id="cine_mass_val" style="font-size:0.8rem; color:var(--accent-teal);
                                  min-width:32px; text-align:right;">0.40s</span>
                        </div>
                    </div>
                    <div class="control-item">
                        <label>Drag <span style="font-size:0.65rem; color:var(--text-muted);">
                            ‚Äî viscosity of medium</span></label>
                        <div class="row" style="gap:8px; align-items:center;">
                            <input type="range" id="cine_drag" min="0.05" max="1.50"
                                   step="0.05" value="0.55"
                                   oninput="updateInertiaLabel('drag'); sendInertia();"
                                   style="flex:3;">
                            <span id="cine_drag_val" style="font-size:0.8rem; color:var(--accent-teal);
                                  min-width:32px; text-align:right;">0.55</span>
                        </div>
                    </div>
                    <div class="button-grid" style="margin-top:6px;">
                        <button class="mode-btn" id="liveStartBtn"
                                onclick="cinematicLiveStart()"
                                style="grid-column:span 2; padding:11px;">
                            ‚ñ∂ Start Live Control
                        </button>
                    </div>
                </div>

                <!-- ‚îÄ‚îÄ PROGRAMMED MODE ‚îÄ‚îÄ -->
                <div id="cine_prog_panel" style="display:none;">

                    <!-- Origin -->
                    <div class="sub-group-title">Origin</div>
                    <div class="row" style="gap:6px; margin-bottom:4px; align-items:center;">
                        <button class="mode-btn" onclick="sendCmd('cinematic_set_origin')"
                                style="flex:2;">üìç Set Origin Here</button>
                        <div id="cine_origin_disp"
                             style="flex:3; font-size:0.68rem; color:var(--text-dim);
                                    font-family:monospace;">not set</div>
                    </div>
                    <div style="font-size:0.65rem; color:var(--text-muted); margin-bottom:8px;">
                        Moves play relative to this position. Set after positioning the rig.
                    </div>

                    <!-- Keyframe list -->
                    <div class="sub-group-title">Keyframes</div>
                    <div id="cine_kf_list" style="margin-bottom:8px; max-height:280px;
                         overflow-y:auto;">
                        <div style="color:var(--text-muted); font-size:0.72rem;
                                    text-align:center; padding:12px 0;">
                            No keyframes. Jog to position and click Add.
                        </div>
                    </div>
                    <div class="row" style="gap:6px; margin-bottom:8px;">
                        <button class="mode-btn" onclick="addKeyframeAtCurrent()"
                                style="flex:2;">+ Add Keyframe</button>
                        <button class="mode-btn" onclick="sendCmd('cinematic_clear_keyframes')"
                                style="flex:1; font-size:0.68rem; color:var(--accent-red);">
                            Clear All</button>
                    </div>

                    <!-- Playback settings -->
                    <div class="sub-group-title">Playback</div>
                    <div class="row">
                        <div class="control-item half">
                            <label>Pre-roll (s)</label>
                            <input type="number" id="cine_preroll" value="3" step="0.5" min="0"
                                   onchange="sendCmd('cinematic_set_preroll',
                                             {seconds: parseFloat(this.value)})">
                        </div>
                        <div class="control-item half">
                            <label>Loop</label>
                            <input type="checkbox" id="cine_loop" style="width:auto; margin-top:8px;"
                                   onchange="sendCmd('cinematic_set_loop', {enabled: this.checked})">
                        </div>
                    </div>

                    <!-- Play controls -->
                    <div class="button-grid" style="margin-top:6px; gap:6px;">
                        <button class="mode-btn" onclick="cinematicPlay()"
                                style="grid-column:span 2; padding:11px;">
                            ‚ñ∂ Play Move
                        </button>
                        <button class="mode-btn" onclick="sendCmd('cinematic_return_to_start')"
                                style="grid-column:span 1; font-size:0.75rem;">
                            ‚Ü© Return to Start
                        </button>
                        <button class="mode-btn stop-style" onclick="sendCmd('cinematic_stop')"
                                style="grid-column:span 1; font-size:0.75rem;">
                            ‚ñ† Stop
                        </button>
                    </div>

                    <!-- Progress bar -->
                    <div id="cine_prog_bar_wrap"
                         style="display:none; margin-top:8px; height:4px;
                                background:#222; border-radius:2px;">
                        <div id="cine_prog_bar" style="height:100%; width:0%;
                             background:var(--accent-teal); border-radius:2px;
                             transition:width 0.3s;"></div>
                    </div>
                    <div id="cine_prog_msg"
                         style="font-size:0.68rem; color:var(--text-dim); margin-top:4px;
                                font-family:monospace; display:none;"></div>

                    <!-- Move Library -->
                    <div class="sub-group-title" style="margin-top:10px;">Move Library</div>
                    <div class="row" style="gap:6px; margin-bottom:6px;">
                        <input type="text" id="cine_move_name" placeholder="Move name‚Ä¶"
                               style="flex:3; font-size:0.8rem; padding:5px 8px;">
                        <button class="mode-btn" onclick="saveCurrentMove()"
                                style="flex:1; font-size:0.68rem;">üíæ Save</button>
                    </div>
                    <div id="cine_move_library" style="max-height:200px; overflow-y:auto;
                         border:var(--border); border-radius:6px; background:var(--panel-dark);">
                        <div style="color:var(--text-muted); font-size:0.72rem;
                                    text-align:center; padding:12px;">No saved moves.</div>
                    </div>
                </div>

            </section>

            <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
            <!-- MACRO FOCUS RAIL / 3D SCAN                         -->
            <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
            <section class="group-box" id="macro_panel" style="display:none;">
                <h3 class="group-title">Macro / 3D Scan <span style="color:var(--accent-gold); font-size:0.65rem;">BETA</span></h3>

                <!-- Sub-mode -->
                <div class="row" style="margin-bottom:10px; gap:6px;">
                    <button class="mode-btn active" id="macroModeScan"
                            onclick="setMacroMode('scan')" style="flex:1;">üî¨ Scan</button>
                    <button class="mode-btn" id="macroModeArt"
                            onclick="setMacroMode('art')" style="flex:1;">üé¨ Art</button>
                </div>

                <!-- Project -->
                <div class="sub-group-title">Project</div>
                <div class="row">
                    <div class="control-item half">
                        <label>Project Name</label>
                        <input type="text" id="macro_project_name" value="macro_project"
                               oninput="macroCalc()">
                    </div>
                    <div class="control-item half">
                        <label>Orbit Label</label>
                        <input type="text" id="macro_orbit_label" value="orbit_001">
                    </div>
                </div>

                <!-- Focus Rail -->
                <div class="sub-group-title">Focus Rail (Slider Motor)</div>
                <div class="row" style="gap:6px; margin-bottom:6px;">
                    <button class="mode-btn" onclick="sendCmd('macro_set_rail_start')"
                            style="flex:1; font-size:0.68rem;">üìç Set Start</button>
                    <button class="mode-btn" onclick="sendCmd('macro_set_rail_end')"
                            style="flex:1; font-size:0.68rem;">üìç Set End</button>
                </div>
                <div class="row" style="font-size:0.68rem; color:var(--text-dim); margin-bottom:6px; gap:12px;">
                    <span>Start: <span id="macro_rail_start_disp" style="color:var(--accent-teal);">‚Äî</span> mm</span>
                    <span>End: <span id="macro_rail_end_disp" style="color:var(--accent-teal);">‚Äî</span> mm</span>
                    <span>Travel: <span id="macro_rail_travel_disp" style="color:var(--accent-gold);">‚Äî</span> mm</span>
                </div>
                <div class="row">
                    <div class="control-item half">
                        <label>Step Size (¬µm)</label>
                        <input type="number" id="macro_step_um" value="100" step="10" min="1"
                               oninput="macroCalc()">
                    </div>
                    <div class="control-item half">
                        <label>Frames / Stack</label>
                        <input type="number" id="macro_frames_per_stack" value="‚Äî"
                               style="color:var(--accent-gold);" readonly>
                    </div>
                </div>
                <div class="row" style="gap:6px; margin-bottom:4px;">
                    <div class="control-item half">
                        <label>Rail Soft Min (mm)</label>
                        <input type="number" id="macro_rail_soft_min" value="-999" step="1"
                               onchange="sendMacroSoftLimits()">
                    </div>
                    <div class="control-item half">
                        <label>Rail Soft Max (mm)</label>
                        <input type="number" id="macro_rail_soft_max" value="999" step="1"
                               onchange="sendMacroSoftLimits()">
                    </div>
                </div>

                <!-- Rotation Stage -->
                <div class="sub-group-title">Rotation Stage (Pan Motor)</div>
                <div class="row" style="gap:6px; margin-bottom:6px;">
                    <button class="mode-btn active" id="macroRotFull" onclick="setRotationMode('full')"
                            style="flex:1; font-size:0.68rem;">360¬∞ Full</button>
                    <button class="mode-btn" id="macroRotRange" onclick="setRotationMode('range')"
                            style="flex:1; font-size:0.68rem;">Range</button>
                </div>
                <div id="macro_rotation_range_controls" style="display:none;">
                    <div class="row" style="gap:6px; margin-bottom:6px;">
                        <button class="mode-btn" onclick="sendCmd('macro_set_rotation_start')"
                                style="flex:1; font-size:0.68rem;">üìç Rot Start</button>
                        <button class="mode-btn" onclick="sendCmd('macro_set_rotation_end')"
                                style="flex:1; font-size:0.68rem;">üìç Rot End</button>
                    </div>
                    <div class="row" style="font-size:0.68rem; color:var(--text-dim); margin-bottom:6px; gap:12px;">
                        <span>Start: <span id="macro_rot_start_disp" style="color:var(--accent-teal);">‚Äî</span>¬∞</span>
                        <span>End: <span id="macro_rot_end_disp" style="color:var(--accent-teal);">‚Äî</span>¬∞</span>
                    </div>
                </div>
                <div class="row">
                    <div class="control-item half">
                        <label>Num Stacks</label>
                        <input type="number" id="macro_num_stacks" value="36" step="1" min="1"
                               oninput="macroCalc()">
                    </div>
                    <div class="control-item half">
                        <label>Spacing Curve</label>
                        <select id="macro_rotation_easing" onchange="macroCalc()">
                            <option value="even">Even</option>
                            <option value="ease_in_out">Ease In/Out</option>
                            <option value="ease_in">Ease In</option>
                            <option value="ease_out">Ease Out</option>
                            <option value="gaussian">Gaussian</option>
                        </select>
                    </div>
                </div>
                <div class="row">
                    <div class="control-item half">
                        <label>Rotation Axis Angle (¬∞)</label>
                        <input type="number" id="macro_rot_axis_angle" value="90" step="1" min="0" max="180"
                               title="90=vertical, 0=horizontal toward camera">
                    </div>
                    <div class="control-item half">
                        <label>Axis Description</label>
                        <input type="text" id="macro_rot_axis_desc" value="vertical">
                    </div>
                </div>

                <!-- Exposure Slots -->
                <div class="sub-group-title">Exposure Slots</div>

                <div class="group-box" style="margin-bottom:8px; padding:10px 8px 8px 8px;">
                    <h3 class="group-title" style="font-size:0.62rem; color:var(--accent-green);">Slot A</h3>
                    <div class="row" style="gap:6px; margin-bottom:4px; align-items:center;">
                        <label class="toggle-label" style="flex:0 0 auto;">
                            <input type="checkbox" id="macro_slot_a_enabled" checked onchange="macroCalc()"> Enable
                        </label>
                        <div class="control-item" style="flex:1; margin:0;">
                            <label>Label</label>
                            <input type="text" id="macro_slot_a_label" value="diffuse" style="padding:3px 6px;">
                        </div>
                    </div>
                    <div class="row" style="gap:6px; margin-bottom:4px; align-items:center;">
                        <label class="toggle-label"><input type="checkbox" id="macro_slot_a_relay1"> R1</label>
                        <label class="toggle-label"><input type="checkbox" id="macro_slot_a_relay2"> R2</label>
                        <div class="control-item" style="flex:1; margin:0;">
                            <label>Settle (ms)</label>
                            <input type="number" id="macro_slot_a_settle" value="0" step="50" min="0" style="padding:3px 6px;">
                        </div>
                        <div class="control-item" style="flex:1; margin:0;">
                            <label>Release (ms)</label>
                            <input type="number" id="macro_slot_a_release" value="0" step="50" min="0" style="padding:3px 6px;">
                        </div>
                    </div>
                    <div class="row" style="gap:4px;">
                        <div class="control-item" style="flex:1; margin:0;"><label>ISO</label>
                            <input type="number" id="macro_slot_a_iso" value="400" step="100" style="padding:3px 4px;"></div>
                        <div class="control-item" style="flex:1; margin:0;"><label>Shutter (s)</label>
                            <input type="number" id="macro_slot_a_shutter" value="0.008" step="0.001" style="padding:3px 4px;"></div>
                        <div class="control-item" style="flex:1; margin:0;"><label>Kelvin</label>
                            <input type="number" id="macro_slot_a_kelvin" value="5500" step="100" style="padding:3px 4px;"></div>
                        <div class="control-item" style="flex:0 0 36px; margin:0;"><label>AE</label>
                            <input type="checkbox" id="macro_slot_a_ae" style="width:auto; margin-top:6px;"></div>
                    </div>
                </div>

                <div class="group-box" style="margin-bottom:8px; padding:10px 8px 8px 8px;">
                    <h3 class="group-title" style="font-size:0.62rem; color:var(--accent-gold);">Slot B</h3>
                    <div class="row" style="gap:6px; margin-bottom:4px; align-items:center;">
                        <label class="toggle-label" style="flex:0 0 auto;">
                            <input type="checkbox" id="macro_slot_b_enabled" onchange="macroCalc()"> Enable
                        </label>
                        <div class="control-item" style="flex:1; margin:0;">
                            <label>Label</label>
                            <input type="text" id="macro_slot_b_label" value="laser" style="padding:3px 6px;">
                        </div>
                    </div>
                    <div class="row" style="gap:6px; margin-bottom:4px; align-items:center;">
                        <label class="toggle-label"><input type="checkbox" id="macro_slot_b_relay1"> R1</label>
                        <label class="toggle-label"><input type="checkbox" id="macro_slot_b_relay2" checked> R2</label>
                        <div class="control-item" style="flex:1; margin:0;">
                            <label>Settle (ms)</label>
                            <input type="number" id="macro_slot_b_settle" value="250" step="50" min="0" style="padding:3px 6px;">
                        </div>
                        <div class="control-item" style="flex:1; margin:0;">
                            <label>Release (ms)</label>
                            <input type="number" id="macro_slot_b_release" value="0" step="50" min="0" style="padding:3px 6px;">
                        </div>
                    </div>
                    <div class="row" style="gap:4px;">
                        <div class="control-item" style="flex:1; margin:0;"><label>ISO</label>
                            <input type="number" id="macro_slot_b_iso" value="200" step="100" style="padding:3px 4px;"></div>
                        <div class="control-item" style="flex:1; margin:0;"><label>Shutter (s)</label>
                            <input type="number" id="macro_slot_b_shutter" value="0.033" step="0.001" style="padding:3px 4px;"></div>
                        <div class="control-item" style="flex:1; margin:0;"><label>Kelvin</label>
                            <input type="number" id="macro_slot_b_kelvin" value="5500" step="100" style="padding:3px 4px;"></div>
                        <div class="control-item" style="flex:0 0 36px; margin:0;"><label>AE</label>
                            <input type="checkbox" id="macro_slot_b_ae" style="width:auto; margin-top:6px;"></div>
                    </div>
                </div>

                <!-- Aux Axis -->
                <div class="sub-group-title">Aux Axis (Tilt Motor)
                    <label class="toggle-label" style="margin-left:8px; font-weight:400;">
                        <input type="checkbox" id="macro_aux_enabled"
                               onchange="toggleAuxAxis(this.checked)"> Enable
                    </label>
                </div>
                <div id="macro_aux_controls" style="display:none;">
                    <div class="row" style="gap:6px; margin-bottom:4px;">
                        <div class="control-item half" style="margin:0;">
                            <label>Label</label>
                            <input type="text" id="macro_aux_label" value="light_arm">
                        </div>
                        <div class="control-item half" style="margin:0;">
                            <label>Easing</label>
                            <select id="macro_aux_easing">
                                <option value="even">Even</option>
                                <option value="ease_in_out">Ease In/Out</option>
                                <option value="ease_in">Ease In</option>
                                <option value="ease_out">Ease Out</option>
                            </select>
                        </div>
                    </div>
                    <div class="row" style="gap:6px; margin-bottom:6px;">
                        <button class="mode-btn" onclick="sendCmd('macro_set_aux_start')"
                                style="flex:1; font-size:0.68rem;">üìç Aux Start</button>
                        <button class="mode-btn" onclick="sendCmd('macro_set_aux_end')"
                                style="flex:1; font-size:0.68rem;">üìç Aux End</button>
                    </div>
                    <div class="row" style="font-size:0.68rem; color:var(--text-dim); margin-bottom:6px; gap:12px;">
                        <span>Start: <span id="macro_aux_start_disp" style="color:var(--accent-teal);">‚Äî</span>¬∞</span>
                        <span>End: <span id="macro_aux_end_disp" style="color:var(--accent-teal);">‚Äî</span>¬∞</span>
                    </div>
                    <div class="row" style="gap:6px;">
                        <div class="control-item half" style="margin:0;">
                            <label>Aux Soft Min (¬∞)</label>
                            <input type="number" id="macro_aux_soft_min" value="-90"
                                   onchange="sendMacroSoftLimits()">
                        </div>
                        <div class="control-item half" style="margin:0;">
                            <label>Aux Soft Max (¬∞)</label>
                            <input type="number" id="macro_aux_soft_max" value="90"
                                   onchange="sendMacroSoftLimits()">
                        </div>
                    </div>
                </div>

                <!-- Timing -->
                <div class="sub-group-title">Timing</div>
                <div class="row">
                    <div class="control-item half">
                        <label>Vibe Delay (s)</label>
                        <input type="number" id="macro_vibe_delay" value="0.5" step="0.1" min="0">
                    </div>
                    <div class="control-item half">
                        <label>Exp Margin (s)</label>
                        <input type="number" id="macro_exp_margin" value="0.2" step="0.1" min="0">
                    </div>
                </div>

                <!-- Lens Profile -->
                <div class="sub-group-title">Lens Profile
                    <span style="color:var(--text-muted); font-size:0.6rem; font-weight:400;"> metadata</span>
                </div>
                <div class="row">
                    <div class="control-item half">
                        <label>Lens Name</label>
                        <input type="text" id="macro_lens_name" value="unknown">
                    </div>
                    <div class="control-item half">
                        <label>Type</label>
                        <select id="macro_lens_type">
                            <option value="macro">Macro</option>
                            <option value="telecentric">Telecentric</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                </div>
                <div class="row">
                    <div class="control-item half">
                        <label>Magnification (√ó)</label>
                        <input type="number" id="macro_lens_mag" value="1.0" step="0.1" min="0">
                    </div>
                    <div class="control-item half">
                        <label>Working Dist. (mm)</label>
                        <input type="number" id="macro_lens_wd" value="0" step="1" min="0">
                    </div>
                </div>
                <div class="row" style="gap:6px; margin-bottom:10px;">
                    <button class="mode-btn" onclick="macroStoreLensProfile()"
                            style="flex:1; font-size:0.68rem;">üíæ Save Profile</button>
                    <select id="macro_lens_profile_select" style="flex:2; font-size:0.78rem;"
                            onchange="macroLoadLensProfile(this.value)">
                        <option value="">‚Äî Load saved ‚Äî</option>
                    </select>
                </div>

                <!-- Summary -->
                <div class="sub-group-title">Sequence Summary</div>
                <div style="background:var(--panel-dark); border:var(--border); border-radius:6px;
                            padding:8px 10px; font-family:monospace; font-size:0.75rem;
                            line-height:1.9; color:var(--text-dim); margin-bottom:10px;">
                    <div>Frames/stack: <span id="macro_sum_frames" style="color:var(--accent-teal);">‚Äî</span></div>
                    <div>Stacks: <span id="macro_sum_stacks" style="color:var(--accent-teal);">‚Äî</span></div>
                    <div>Total images: <span id="macro_sum_images" style="color:var(--accent-gold);">‚Äî</span></div>
                    <div>Est. storage: <span id="macro_sum_storage" style="color:var(--accent-gold);">‚Äî</span> GB</div>
                </div>

                <!-- Start / Abort -->
                <div class="button-grid" style="gap:8px;">
                    <button class="mode-btn" id="macroStartBtn" onclick="macroStart()"
                            style="grid-column:span 2; padding:11px;">‚ñ∂ Start Sequence</button>
                </div>

                <!-- Progress panel (shown during run) -->
                <div id="macro_progress_panel" style="display:none; margin-top:10px;
                     background:var(--panel-dark); border:var(--border); border-radius:6px; padding:8px 10px;">
                    <div style="font-size:0.7rem; color:var(--text-dim); font-family:monospace; line-height:1.8;">
                        <div>Stack: <span id="macro_prog_stack" style="color:var(--accent-teal);">‚Äî</span> /
                             <span id="macro_prog_total_stacks">‚Äî</span></div>
                        <div>Frame: <span id="macro_prog_frame" style="color:var(--accent-teal);">‚Äî</span> /
                             <span id="macro_prog_total_frames">‚Äî</span></div>
                        <div>Rotation: <span id="macro_prog_rot" style="color:var(--accent-gold);">‚Äî</span>¬∞</div>
                        <div>Rail: <span id="macro_prog_rail" style="color:var(--accent-gold);">‚Äî</span> mm</div>
                        <div id="macro_prog_msg" style="color:var(--text-dim); white-space:nowrap;
                             overflow:hidden; text-overflow:ellipsis;"></div>
                    </div>
                    <div style="margin-top:6px; height:4px; background:#333; border-radius:2px;">
                        <div id="macro_prog_bar" style="height:100%; width:0%;
                             background:var(--accent-teal); border-radius:2px; transition:width 0.3s;"></div>
                    </div>
                </div>
            </section>

        </aside>

        <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
        <!-- THE STAGE                                               -->
        <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
        <div id="stage">

            <!-- Live Feed + Loupe Overlay -->
            <section class="group-box visualizer-box">
                <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:6px;">
                    <h3 class="group-title" id="feedLabel" style="margin:0; flex:1;">Optical Feed ‚Äî Framing (640√ó360) + Focus Loupe</h3>

                    <!-- Camera orientation -->
                    <div style="display:flex; gap:3px; margin-right:6px;">
                        <button id="orientLand" onclick="setCameraOrientation('landscape')"
                                title="Landscape (normal)"
                                style="background:var(--accent-teal); border:1px solid var(--accent-teal);
                                       color:#000; border-radius:4px; padding:4px 7px;
                                       cursor:pointer; font-size:0.8rem; line-height:1;">‚¨ú</button>
                        <button id="orientCW" onclick="setCameraOrientation('portrait_cw')"
                                title="Portrait ‚Äî rotated 90¬∞ clockwise"
                                style="background:none; border:1px solid #444;
                                       color:#666; border-radius:4px; padding:4px 7px;
                                       cursor:pointer; font-size:0.8rem; line-height:1;">‚Üª</button>
                        <button id="orientCCW" onclick="setCameraOrientation('portrait_ccw')"
                                title="Portrait ‚Äî rotated 90¬∞ counter-clockwise"
                                style="background:none; border:1px solid #444;
                                       color:#666; border-radius:4px; padding:4px 7px;
                                       cursor:pointer; font-size:0.8rem; line-height:1;">‚Ü∫</button>
                        <button id="orientFlip" onclick="setCameraOrientation('inverted')"
                                title="Inverted ‚Äî 180¬∞"
                                style="background:none; border:1px solid #444;
                                       color:#666; border-radius:4px; padding:4px 7px;
                                       cursor:pointer; font-size:0.8rem; line-height:1;">‚¨õ</button>
                    </div>

                    <button id="loupeToggleBtn"
                            onclick="toggleLoupeVisibility()"
                            title="Show/hide focus loupe"
                            style="background:none; border:1px solid var(--accent-teal);
                                   color:var(--accent-teal); border-radius:6px;
                                   padding:4px 10px; cursor:pointer; font-size:0.85rem;
                                   flex-shrink:0;">
                        üîç
                    </button>
                    <button id="previewToggleBtn"
                            onclick="togglePreviewCamera()"
                            style="display:none; font-size:0.7rem; padding:3px 10px;
                                   background:var(--panel-light); border:var(--border);
                                   border-radius:6px; color:var(--accent-teal); cursor:pointer;
                                   white-space:nowrap;">
                        üì∑ PiCam
                    </button>
                </div>
                <div class="canvas-container" id="feedContainer">
                    <!-- Main low-res framing stream (shown when idle) -->
                    <img id="mjpegFeed" src="/video_feed" alt="live feed"
                         style="position:absolute; top:0; left:0; width:100%; height:100%;
                                object-fit:contain; z-index:1;">

                    <!-- Latest captured frame (shown during run) -->
                    <img id="latestFrame" src="/latest_frame" alt="last shot"
                         style="position:absolute; top:0; left:0; width:100%; height:100%;
                                object-fit:contain; display:none; z-index:1;">

                    <!-- Canvas overlay: loupe magnifier + motion ROI box ‚Äî always on top -->
                    <canvas id="overlayCanvas"
                            style="position:absolute; top:0; left:0; width:100%; height:100%;
                                   pointer-events:none; z-index:10;">
                    </canvas>

                    <!-- Crosshair reticle -->
                    <div id="feedReticle"></div>
                </div>
                <div id="statusLine">STATUS: IDLE</div>
            </section>

            <!-- Interaction Row -->
            <div id="interactionArea">

                <!-- Joystick -->
                <section class="group-box joystick-box">
                    <h3 class="group-title">Manual Vector (UART)</h3>
                    <div class="motion-content">
                        <div class="dial-wrap">
                            <div class="dial-container">
                                <div class="dial-inner" id="joystickPad">
                                    <div id="joystickKnob" class="dial-knob"></div>
                                </div>
                            </div>
                            <!-- Slider axis strip (linear, single axis) -->
                            <div class="slider-strip-wrap">
                                <div class="slider-strip-label">‚óÄ SLIDER ‚ñ∂</div>
                                <div class="slider-strip-track" id="sliderStrip">
                                    <div id="sliderStripKnob" class="slider-strip-knob"></div>
                                </div>
                            </div>
                        </div>
                        <div class="readouts">
                            <div class="readout-card">SLIDER: <span id="val_s">0.0</span> mm</div>
                            <div class="readout-card">PAN:    <span id="val_p">0.0</span> ¬∞</div>
                            <div class="readout-card">TILT:   <span id="val_t">0.0</span> ¬∞</div>
                        </div>
                    </div>
                </section>

                <!-- Progress + HG Telemetry -->
                <section class="group-box progress-box">
                    <h3 class="group-title">Sequence Progress</h3>
                    <div class="progress-display">
                        <div class="big-frame-num">
                            <span id="cur_f">000</span> / <span id="tot_f">300</span>
                        </div>
                        <div class="time-est" id="progress_msg">Idle</div>

                        <!-- Disk space indicator (always visible) -->
                        <div id="disk_space_row" class="readout-card"
                             style="font-size:0.72rem; text-align:left; margin-top:6px; width:100%;">
                            üíæ <span id="disk_free_label">Checking‚Ä¶</span>
                        </div>
                        <!-- Pre-flight warning: shown when sequence won't fit -->
                        <div id="disk_preflight_warn"
                             style="display:none; margin-top:4px; width:100%; font-size:0.7rem;
                                    color:var(--accent-gold); font-family:monospace; text-align:left;
                                    padding:4px 8px; background:rgba(255,210,80,0.08);
                                    border:1px solid rgba(255,210,80,0.3); border-radius:6px;">
                        </div>

                        <!-- Estimated end / frames (visible when running) -->
                        <div id="progress_estimates" style="width:100%; margin-top:6px; display:none;">
                            <div class="readout-card" style="font-size:0.75rem; text-align:left; margin-bottom:4px;">
                                Est. finish: <span id="est_end">‚Äî</span>
                                &nbsp;|&nbsp; Remaining: <span id="est_remaining">‚Äî</span>
                            </div>
                            <div class="readout-card" style="font-size:0.75rem; text-align:left;">
                                Current interval: <span id="cur_interval">‚Äî</span>s
                                <span id="hg_interval_note" style="color:var(--accent-gold); display:none;">
                                    &nbsp;(HG adaptive)
                                </span>
                            </div>
                        </div>

                        <div style="margin-top:10px; width:100%;">
                            <div class="readout-card" style="font-size:0.8rem; text-align:left; margin-bottom:6px;">
                                Phase: <span id="hg_phase">‚Äî</span> &nbsp;|&nbsp;
                                Sun: <span id="hg_sun_alt">‚Äî</span>¬∞ &nbsp;|&nbsp;
                                EV: <span id="hg_ev">‚Äî</span>
                            </div>
                            <div class="readout-card" style="font-size:0.8rem; text-align:left;">
                                ISO: <span id="hg_iso">‚Äî</span> &nbsp;|&nbsp;
                                Shutter: <span id="hg_shutter">‚Äî</span> &nbsp;|&nbsp;
                                WB: <span id="hg_kelvin">‚Äî</span>K
                            </div>
                        </div>

                        <!-- Session Graph button -->
                        <button id="graphBtn"
                            onclick="window.open('/graph','pislider-graph','width=1400,height=800')"
                            style="width:100%; margin-top:10px; padding:7px;
                                   background:none; border:1px solid var(--accent-teal);
                                   color:var(--accent-teal); font-family:monospace;
                                   font-size:0.75rem; letter-spacing:0.08em; cursor:pointer;
                                   text-transform:uppercase; transition:background 0.2s, color 0.2s;"
                            onmouseover="this.style.background='rgba(0,204,170,0.12)'"
                            onmouseout="this.style.background='none'">
                            üìà SESSION GRAPH
                        </button>
                    </div>
                </section>

            </div>
        </div>
    </main>

    <footer id="footer">
        <div id="debugOverlay">LOG: WebSocket Initialising‚Ä¶</div>
    </footer>

    <script src="/static/main.js"></script>

    <!-- ‚îÄ‚îÄ FOLDER BROWSER MODAL ‚îÄ‚îÄ -->
    <div id="folderModal" class="modal-overlay" style="display:none;" onclick="closeFolderBrowser(event)">
        <div class="modal-box" onclick="event.stopPropagation()" style="width:min(600px,95vw); max-height:80vh;">

            <!-- Header: breadcrumb path + close -->
            <div class="modal-header" style="gap:10px; flex-wrap:wrap;">
                <div style="display:flex; align-items:center; gap:6px; flex:1; min-width:0;">
                    <span style="color:var(--text-dim); font-size:0.75rem; white-space:nowrap;">üìÇ</span>
                    <span id="folderModalPath"
                          style="font-family:monospace; font-size:0.78rem; color:var(--accent-teal);
                                 overflow:hidden; text-overflow:ellipsis; white-space:nowrap;"></span>
                </div>
                <button onclick="closeFolderBrowser()" style="padding:4px 10px; flex-shrink:0;">‚úï</button>
            </div>

            <!-- Drives quick-jump bar -->
            <div id="drivesBar"
                 style="padding:6px 12px; border-bottom:var(--border); display:flex;
                        gap:6px; flex-wrap:wrap; background:var(--panel-dark);">
                <span style="font-size:0.7rem; color:var(--text-dim); align-self:center;">Jump:</span>
                <button class="drive-chip" id="chip_home"  onclick="browseTo('/home/tim')">üè† Home</button>
                <button class="drive-chip" id="chip_pics"  onclick="browseTo('/home/tim/Pictures')">üñº Pictures</button>
                <button class="drive-chip" id="chip_media" onclick="browseTo('/media/tim')">üíæ Media</button>
                <button class="drive-chip" id="chip_mnt"   onclick="browseTo('/mnt')">üóÑ Mounts</button>
                <button class="drive-chip" onclick="scanDrives()">‚ü≥</button>
            </div>

            <!-- Body: folder list -->
            <div id="folderList" class="folder-list" style="min-height:220px;"></div>

            <!-- Disk usage bar -->
            <div id="folderDiskBar"
                 style="padding:5px 14px; border-top:var(--border); font-size:0.7rem;
                        color:var(--text-dim); font-family:monospace; background:var(--panel-dark);">
                üíæ <span id="folderDiskInfo">‚Äî</span>
            </div>

            <!-- Footer: selected path + create folder + confirm -->
            <div class="modal-footer" style="flex-wrap:wrap; gap:8px;">
                <span id="folderSelectedPath"
                      style="font-size:0.72rem; color:var(--accent-teal); flex:1;
                             font-family:monospace; min-width:0; overflow:hidden;
                             text-overflow:ellipsis; white-space:nowrap;"></span>
                <div style="display:flex; gap:6px; flex-shrink:0;">
                    <button class="mode-btn" style="font-size:0.75rem; padding:5px 10px;"
                            onclick="createFolderPrompt()">+ New Folder</button>
                    <button class="mode-btn" onclick="confirmFolderSelection()">Select</button>
                </div>
            </div>

            <!-- Inline create-folder row (hidden by default) -->
            <div id="newFolderRow"
                 style="display:none; padding:8px 14px; border-top:var(--border);
                        background:var(--panel-dark); gap:8px; flex-wrap:wrap;"
                 class="row">
                <input type="text" id="newFolderName" placeholder="New folder name"
                       style="flex:1; min-width:120px;"
                       onkeydown="if(event.key==='Enter')confirmCreateFolder(); if(event.key==='Escape')cancelCreateFolder();">
                <button class="mode-btn" style="padding:5px 12px;" onclick="confirmCreateFolder()">Create</button>
                <button style="padding:5px 10px; background:none; border:var(--border);
                               border-radius:6px; color:var(--text-dim); cursor:pointer;"
                        onclick="cancelCreateFolder()">Cancel</button>
            </div>
        </div>
    </div>
</body>
</html>
